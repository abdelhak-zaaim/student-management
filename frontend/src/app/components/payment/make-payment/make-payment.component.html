<div class="grid">
    <div class="col-12">
        <div class="card">
            <h5>Make a Payment</h5>
            <p>Create a new payment for a student.</p>

            <div class="p-fluid formgrid grid">
                <div class="field col-12 md:col-6">
                    <label for="student" class="font-bold">Student*</label>
                    <p-dropdown id="student" [options]="students" [(ngModel)]="payment.student"
                              optionLabel="displayName" dataKey="id"
                              [filter]="true" filterBy="displayName"
                              [showClear]="true"
                              placeholder="Select a Student"
                              [disabled]="loading"
                              [ngClass]="{'ng-invalid ng-dirty': submitted && !payment.student}"></p-dropdown>
                    <small class="p-error" *ngIf="submitted && !payment.student">Student is required.</small>
                </div>

                <div class="field col-12 md:col-6">
                    <label for="amount" class="font-bold">Amount*</label>
                    <p-inputNumber id="amount" [(ngModel)]="payment.amount"
                                 mode="currency" currency="USD" locale="en-US"
                                 [min]="0" [maxFractionDigits]="2"
                                 [disabled]="loading"
                                 [ngClass]="{'ng-invalid ng-dirty': submitted && !payment.amount}"></p-inputNumber>
                    <small class="p-error" *ngIf="submitted && !payment.amount">Amount is required.</small>
                </div>

                <div class="field col-12 md:col-6">
                    <label for="status" class="font-bold">Status*</label>
                    <p-dropdown id="status" [options]="statuses" [(ngModel)]="payment.status"
                              optionLabel="label" optionValue="value"
                              placeholder="Select a Status" [showClear]="false"
                              [disabled]="loading"
                              [ngClass]="{'ng-invalid ng-dirty': submitted && !payment.status}"></p-dropdown>
                    <small class="p-error" *ngIf="submitted && !payment.status">Status is required.</small>
                </div>

                <div class="field col-12 md:col-6">
                    <label for="date" class="font-bold">Payment Date*</label>
                    <p-calendar id="date" [(ngModel)]="payment.date" dateFormat="yy-mm-dd"
                              [showTime]="true" [showButtonBar]="true"
                              [readonlyInput]="false" [showIcon]="true"
                              [disabled]="loading"
                              [ngClass]="{'ng-invalid ng-dirty': submitted && !payment.date}"></p-calendar>
                    <small class="p-error" *ngIf="submitted && !payment.date">Date is required.</small>
                </div>

                <div class="field col-12">
                    <div class="flex justify-content-end">
                        <p-button label="Cancel" icon="pi pi-times" styleClass="p-button-text mr-2" (onClick)="cancel()" [disabled]="loading"></p-button>
                        <p-button label="Reset" icon="pi pi-refresh" styleClass="p-button-secondary mr-2" (onClick)="resetForm()" [disabled]="loading"></p-button>
                        <p-button label="Make Payment" icon="pi pi-check" (onClick)="makePayment()" [loading]="loading"></p-button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Receipt Preview Dialog -->
<p-dialog [(visible)]="receiptDialog"
         header="Payment Receipt"
         [modal]="true"
         [style]="{width:'650px'}"
         [maximizable]="true"
         [closable]="true"
         styleClass="p-fluid receipt-dialog">
    <div *ngIf="isLoading" class="flex justify-content-center p-4">
        <p-progressSpinner></p-progressSpinner>
    </div>

    <div *ngIf="!isLoading && createdPayment" class="payment-receipt">
        <!-- Receipt Header -->
        <div class="receipt-header text-center mb-4">
            <h2 class="text-primary mb-2">BEGENIUS</h2>
            <h3 class="text-secondary">PAYMENT RECEIPT</h3>
        </div>

        <!-- Receipt Details -->
        <div class="grid">
            <!-- Left Column - Receipt Details -->
            <div class="col-12 md:col-6">
                <h4>Receipt Details</h4>
                <div class="receipt-field mb-2">
                    <span class="font-bold">Receipt #:</span>
                    <span>{{createdPayment.id || 'Pending'}}</span>
                </div>
                <div class="receipt-field mb-2">
                    <span class="font-bold">Date:</span>
                    <span>{{createdPayment.date | date:'medium'}}</span>
                </div>
                <div class="receipt-field mb-2">
                    <span class="font-bold">Status:</span>
                    <span [class]="'payment-badge status-' + createdPayment.status?.toLowerCase()">
                        {{createdPayment.status}}
                    </span>
                </div>
            </div>

            <!-- Right Column - Student Info -->
            <div class="col-12 md:col-6">
                <h4>Student Information</h4>
                <div *ngIf="createdPayment.student?.user" class="mb-2">
                    <div class="receipt-field mb-2">
                        <span class="font-bold">Name:</span>
                        <span>{{createdPayment.student?.user?.firstName}} {{createdPayment.student?.user?.lastName}}</span>
                    </div>
                    <div class="receipt-field mb-2">
                        <span class="font-bold">ID:</span>
                        <span>{{createdPayment.student?.id}}</span>
                    </div>
                    <div class="receipt-field mb-2">
                        <span class="font-bold">Group:</span>
                        <span>{{createdPayment.student?.studentGroup?.name || 'N/A'}}</span>
                    </div>
                </div>
                <div *ngIf="!createdPayment.student?.user">
                    <p class="text-muted">Student information not available</p>
                </div>
            </div>
        </div>

        <!-- Payment Amount -->
        <div class="mt-4 p-3 surface-100 border-round">
            <div class="grid">
                <div class="col-6">
                    <span class="font-bold">Tuition Payment</span>
                </div>
                <div class="col-6 text-right">
                    <span class="font-bold">{{createdPayment.amount | currency:'USD':'symbol':'1.2-2'}}</span>
                </div>
            </div>
            <hr class="my-2" />
            <div class="grid">
                <div class="col-6">
                    <span class="font-bold text-xl">Total</span>
                </div>
                <div class="col-6 text-right">
                    <span class="font-bold text-xl">{{createdPayment.amount | currency:'USD':'symbol':'1.2-2'}}</span>
                </div>
            </div>
        </div>

        <!-- Receipt Footer -->
        <div class="mt-4 text-center">
            <p class="mb-1">Thank you for your payment!</p>
            <p class="text-sm text-muted">This is an electronically generated receipt and does not require a signature.</p>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <div class="flex justify-content-end w-full">
            <p-button label="Close" icon="pi pi-times" styleClass="p-button-text mr-2" (onClick)="receiptDialog = false"></p-button>
            <p-button label="Download PDF" icon="pi pi-file-pdf" styleClass="p-button-info"
                     [disabled]="!createdPayment" (onClick)="downloadReceipt()"></p-button>
        </div>
    </ng-template>
</p-dialog>

<p-toast></p-toast>
